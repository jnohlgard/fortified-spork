#!/usr/bin/sh
set -eu

lukshdrs_device=/dev/disk/by-partlabel/lukshdrs
data_device_base=/dev/disk/by-partuuid/

systemctl start systemd-cryptsetup@lukshdrs
systemd-mount /dev/mapper/lukshdrs /var/lib/lukshdrs

for header_file in /var/lib/lukshdrs/*.luks; do
  header_name="${header_file##*/}"
  luks_name="${header_name%.luks}"
  data_device="${data_device_base}${luks_name}"
  if [ -b "${data_device}" ]; then
    cryptsetup open --header "${header_file}" "${data_device}" "luks-${luks_name}"
  fi
done

systemd-umount /var/lib/lukshdrs
systemctl stop systemd-cryptsetup@lukshdrs
